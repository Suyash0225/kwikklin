<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kwik Klin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-login {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #f0fdf4, #e0f2fe);
        }

        .login-card {
            background: white;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid #e2e8f0;
        }

        .dashboard {
            display: none;
            min-height: 100vh;
            background: #f8fafc;
        }

        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 2rem 1.5rem;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 0.75rem;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #e0f2fe;
            color: var(--primary);
            font-weight: 600;
        }

        .main-content {
            margin-left: 250px;
            padding: 2rem;
            width: calc(100% - 250px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .grid-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .admin-item-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
        }

        .admin-item-img {
            height: 150px;
            width: 100%;
            object-fit: cover;
        }

        .admin-item-body {
            padding: 1rem;
        }

        .delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            color: var(--accent);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .edit-btn {
            position: absolute;
            top: 0.5rem;
            right: 3rem;
            /* Spaced from delete btn */
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .delete-btn:hover {
            background: var(--accent);
            color: white;
        }

        .edit-btn:hover {
            background: var(--primary);
            color: white;
        }

        .logout-btn {
            margin-top: auto;
            color: var(--accent);
            cursor: pointer;
            position: absolute;
            bottom: 2rem;
            left: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 1rem;
                display: flex;
                overflow-x: auto;
                gap: 1rem;
                border-bottom: 1px solid #e2e8f0;
                border-right: none;
            }

            .sidebar-brand {
                display: none;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }

            .nav-item {
                margin-bottom: 0;
                white-space: nowrap;
            }

            .logout-btn {
                position: relative;
                bottom: auto;
                left: auto;
                color: var(--accent);
            }
        }
    </style>
    <style>
        /* Slider Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>

<body>

    <!-- Login Screen -->
    <div id="login-screen" class="admin-login">
        <div class="login-card">
            <h2 style="margin-bottom: 0.5rem; color: var(--primary);">
                <i class="bi bi-shield-lock"></i> Admin Access
            </h2>
            <p style="color: var(--gray); margin-bottom: 2rem; font-size: 0.9rem;">Enter your hygiene PIN</p>

            <div style="position: relative; margin-bottom: 1.5rem;">
                <input type="password" id="pin-input" class="form-input" placeholder="Enter PIN"
                    style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem; padding-right: 40px;">
                <i class="bi bi-eye-slash" id="login-eye-icon" onclick="toggleLoginPin()"
                    style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--gray); font-size: 1.2rem;"></i>
            </div>

            <button onclick="checkLogin()" class="btn btn-primary"
                style="width: 100%; justify-content: center; font-size: 1.1rem; padding: 0.8rem;">
                Unlock Dashboard
            </button>
            <div id="error-msg"
                style="color: #ef4444; background: #fee2e2; padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem; display: none; font-size: 0.9rem; border: 1px solid #fca5a5;">
                <i class="bi bi-exclamation-circle-fill"></i> Incorrect PIN. Try again.
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <i class="bi bi-speedometer2"></i> Dashboard
            </div>

            <div class="nav-item active" onclick="switchTab('services')">
                <i class="bi bi-box-seam"></i> Services
            </div>
            <div class="nav-item" onclick="switchTab('blogs')">
                <i class="bi bi-newspaper"></i> Blogs
            </div>
            <div class="nav-item" onclick="switchTab('story')">
                <i class="bi bi-book"></i> Our Story
            </div>
            <div class="nav-item" onclick="switchTab('profile')">
                <i class="bi bi-person-gear"></i> Profile & PIN
            </div>

            <div class="logout-btn" onclick="logout()">
                <i class="bi bi-box-arrow-left"></i> Logout
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">

            <!-- SERVICES TAB -->
            <div id="services-tab" class="tab-content active">
                <h2 style="margin-bottom: 1.5rem;">Manage Services</h2>

                <div class="card">
                    <h3>Add New Service</h3>
                    <form onsubmit="handleServiceSubmit(event)" style="display: grid; gap: 1rem; margin-top: 1rem;"
                        id="service-form">
                        <input type="hidden" id="s-id">
                        <input type="text" id="s-name" placeholder="Service Name (e.g., Saree Polish)"
                            class="form-input" required>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <select id="s-cat" class="form-input" required>
                                <option value="" disabled selected>Select Category</option>
                                <option value="Dry Clean">Dry Clean</option>
                                <option value="Premium Wash">Premium Wash</option>
                                <option value="Normal Wash">Normal Wash</option>
                                <option value="Shoe Cleaning">Shoe Cleaning</option>
                                <option value="Household">Household</option>
                            </select>
                            <input type="number" id="s-price" placeholder="Price (₹)" class="form-input" required>
                        </div>
                        <select id="s-subcat" class="form-input" required>
                            <option value="" disabled selected>Select Sub-category</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Child">Child</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="url" id="s-img" placeholder="Image URL" class="form-input" required>
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary" id="s-submit-btn"><i
                                    class="bi bi-plus-lg"></i> Add Service</button>
                            <button type="button" class="btn btn-secondary" id="s-cancel-btn" style="display: none;"
                                onclick="resetServiceForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <h3 style="margin-top: 2rem;">Current Services</h3>
                <div id="services-list" class="grid-list">
                    <!-- Dynamic Items -->
                </div>
            </div>

            <!-- BLOGS TAB -->
            <div id="blogs-tab" class="tab-content">
                <h2 style="margin-bottom: 1.5rem;">Manage Blogs</h2>

                <div class="card">
                    <h3>Post New Blog</h3>
                    <form onsubmit="handleBlogSubmit(event)" style="display: grid; gap: 1rem; margin-top: 1rem;"
                        id="blog-form">
                        <input type="hidden" id="b-id">
                        <input type="text" id="b-title" placeholder="Blog Title" class="form-input" required>
                        <input type="text" id="b-cat" placeholder="Category (e.g. Tips)" class="form-input" required>
                        <input type="url" id="b-img" placeholder="Cover Image URL" class="form-input" required>
                        <textarea id="b-snippet" placeholder="Short description..." class="form-input" rows="3"
                            required></textarea>
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn-primary" id="b-submit-btn"><i
                                    class="bi bi-pencil-square"></i> Publish Blog</button>
                            <button type="button" class="btn btn-secondary" id="b-cancel-btn" style="display: none;"
                                onclick="resetBlogForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <h3 style="margin-top: 2rem;">Published Blogs</h3>
                <div id="blogs-list" class="grid-list">
                    <!-- Dynamic Blogs -->
                </div>
            </div>

            <!-- STORY TAB -->
            <div id="story-tab" class="tab-content">
                <h2 style="margin-bottom: 1.5rem;">Edit "Our Story"</h2>
                <div class="card">
                    <form onsubmit="updateStory(event)" style="display: grid; gap: 1rem;">
                        <label>Main Title</label>
                        <input type="text" id="st-title" class="form-input">

                        <label>Subtitle</label>
                        <input type="text" id="st-subtitle" class="form-input">

                        <label>Hero Image URL</label>
                        <input type="url" id="st-img" class="form-input">

                        <label>Main Content</label>
                        <textarea id="st-content" class="form-input" rows="8"></textarea>

                        <label>Vision Statement</label>
                        <textarea id="st-vision" class="form-input" rows="3"></textarea>

                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="profile-tab" class="tab-content">
                <h2 style="margin-bottom: 1.5rem;">Admin Settings</h2>

                <!-- 1. Admin Profile Card -->
                <div class="card"
                    style="margin-bottom: 2rem; display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                    <div
                        style="width: 80px; height: 80px; background: #e0e7ff; color: #4338ca; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <div style="flex: 1;">
                        <h3 id="admin-name" style="margin-bottom: 0.25rem;">Admin</h3>
                        <div
                            style="display: flex; gap: 1.5rem; color: var(--gray); font-size: 0.9rem; flex-wrap: wrap;">
                            <span><i class="bi bi-shield-check"></i> <span id="admin-role">Admin</span></span>
                            <span><i class="bi bi-envelope"></i> <span id="admin-email">admin@kwikklin.com</span></span>
                            <span><i class="bi bi-telephone"></i> <span id="admin-phone">9696856069</span></span>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <span class="status-badge" style="background: #dcfce7; color: #15803d;">Active</span>
                    </div>
                </div>

                <!-- 2. Stats Grid -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Services Stat -->
                    <div class="card" style="display: flex; align-items: center; gap: 1rem; padding: 1.5rem;">
                        <div
                            style="background: #e0f2fe; color: #0ea5e9; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div>
                            <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0;">Total Services</p>
                            <h3 id="total-services" style="font-size: 1.8rem; margin: 0;">0</h3>
                        </div>
                    </div>

                    <!-- Visits Stat -->
                    <div class="card" style="display: flex; align-items: center; gap: 1rem; padding: 1.5rem;">
                        <div
                            style="background: #f0fdf4; color: #22c55e; width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                            <i class="bi bi-people"></i>
                        </div>
                        <div>
                            <p style="color: var(--gray); font-size: 0.9rem; margin-bottom: 0;">Site Visits</p>
                            <h3 id="total-visits" style="font-size: 1.8rem; margin: 0;">0</h3>
                        </div>
                    </div>

                    <!-- Login Activity Stat -->
                    <div class="card" style="display: flex; flex-direction: column; gap: 0.5rem; padding: 1.5rem;">
                        <h4 style="font-size: 0.9rem; color: var(--gray); font-weight: 600;">LOGIN ACTIVITY</h4>
                        <div style="font-size: 0.85rem;">
                            <div>Last: <span id="last-login" style="font-weight: 600;">Never</span></div>
                            <div style="color: #64748b; font-size: 0.75rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 150px;"
                                id="login-device">-</div>
                            <div style="margin-top: 4px;">Failed Attempts: <span id="failed-attempts"
                                    style="color: #ef4444; font-weight: 700;">0</span></div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">

                    <!-- 3. Improved Change PIN -->
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-shield-lock"></i> Security
                        </h3>
                        <form onsubmit="changePin(event)">
                            <div class="form-group">
                                <label>New Admin PIN</label>
                                <div style="position: relative;">
                                    <input type="password" id="new-pin" class="form-input" placeholder="4-6 digits"
                                        required pattern="\d{4,6}" maxlength="6">
                                    <i class="bi bi-eye-slash" onclick="togglePinVisibility('new-pin', this)"
                                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--gray);"></i>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Confirm New PIN</label>
                                <div style="position: relative;">
                                    <input type="password" id="confirm-pin" class="form-input" placeholder="Confirm PIN"
                                        required pattern="\d{4,6}" maxlength="6">
                                </div>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--gray); margin-bottom: 1rem;">
                                <i class="bi bi-info-circle"></i> Use 4 to 6 digits.
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                                Update PIN
                            </button>
                        </form>
                    </div>

                    <!-- 4. Site Control Toggles -->
                    <div class="card">
                        <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="bi bi-sliders"></i> Site Controls
                        </h3>

                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">Maintenance Mode</div>
                                    <div style="font-size: 0.8rem; color: var(--gray);">Take site offline</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="toggle-maintenance"
                                        onchange="toggleSiteSetting('maintenanceMode', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">Allow Orders</div>
                                    <div style="font-size: 0.8rem; color: var(--gray);">Enable checkout</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="toggle-orders"
                                        onchange="toggleSiteSetting('allowOrders', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>

                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600;">Show Blogs</div>
                                    <div style="font-size: 0.8rem; color: var(--gray);">Display blog section</div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="toggle-blogs"
                                        onchange="toggleSiteSetting('allowBlogs', this.checked)">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>

                        <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                            <button onclick="factoryReset()"
                                style="color: #ef4444; background: none; border: none; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; width: 100%; justify-content: center;">
                                <i class="bi bi-trash"></i> Factory Reset Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Go Home Link -->
    <a href="index.html" class="btn btn-secondary"
        style="position: fixed; bottom: 2rem; right: 2rem; z-index: 100; box-shadow: var(--shadow-lg);">
        <i class="bi bi-house"></i> View Website
    </a>

    <script src="data.js"></script>
    <script>
        // --- Auth Logic ---
        function toggleLoginPin() {
            const input = document.getElementById('pin-input');
            const icon = document.getElementById('login-eye-icon');
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove("bi-eye-slash");
                icon.classList.add("bi-eye");
            } else {
                input.type = "password";
                icon.classList.remove("bi-eye");
                icon.classList.add("bi-eye-slash");
            }
        }

        function checkLogin() {
            const pin = document.getElementById('pin-input').value;
            // Ensure DataManager is loaded
            if (typeof DataManager === 'undefined') {
                alert("System Error: Data module not loaded. Please refresh.");
                return;
            }

            if (DataManager.checkAdmin(pin)) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                // Log success
                DataManager.logLogin(true);
                // Load Dashboard Data
                loadDashboard();
                loadAllData();
            } else {
                // Log failure
                DataManager.logLogin(false);
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        function logout() {
            location.reload();
        }

        // --- Tabs ---
        function switchTab(tabId) {
            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active'); // Works because of inline onclick

            // Update Content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId + '-tab').classList.add('active');
        }

        function loadAllData() {
            renderServices();
            renderBlogs();
            loadStory();
        }

        // --- Services ---
        function renderServices() {
            const list = document.getElementById('services-list');
            list.innerHTML = '';
            DataManager.getServices().forEach(s => {
                // Determine category color/icon if needed, but keeping it simple
                list.innerHTML += `
                    <div class="admin-item-card">
                        <button class="delete-btn" onclick="removeServiceItem('${s.id}')"><i class="bi bi-trash"></i></button>
                        <button class="edit-btn" onclick='editService(${JSON.stringify(s)})'><i class="bi bi-pencil"></i></button>
                        <img src="${s.image}" class="admin-item-img">
                        <div class="admin-item-body">
                            <h4>${s.name}</h4>
                            <p style="color: var(--primary); font-size: 0.9rem;">${s.category} <span style="color:#64748b; font-size:0.8rem;">(${s.subCategory || 'Other'})</span></p>
                            <p style="font-weight: 700;">₹${s.price}</p>
                        </div>
                    </div>
                `;
            });
        }

        function handleServiceSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('s-id').value;
            const service = {
                name: document.getElementById('s-name').value,
                category: document.getElementById('s-cat').value,
                subCategory: document.getElementById('s-subcat').value,
                price: Number(document.getElementById('s-price').value),
                image: document.getElementById('s-img').value
            };

            if (id) {
                // Update
                service.id = id;
                DataManager.updateService(service);
                alert('Service Updated!');
            } else {
                // Add
                DataManager.addService(service);
                alert('Service Added!');
            }

            resetServiceForm();
            renderServices();
        }

        function editService(service) {
            document.getElementById('s-id').value = service.id;
            document.getElementById('s-name').value = service.name;
            document.getElementById('s-cat').value = service.category;
            // Set default if not present (legacy data support)
            document.getElementById('s-subcat').value = service.subCategory || 'Other';
            document.getElementById('s-price').value = service.price;
            document.getElementById('s-img').value = service.image;

            document.getElementById('s-submit-btn').innerHTML = '<i class="bi bi-check-lg"></i> Update Service';
            document.getElementById('s-cancel-btn').style.display = 'inline-flex';
            window.scrollTo(0, 0);
        }

        function resetServiceForm() {
            document.getElementById('service-form').reset();
            document.getElementById('s-id').value = '';
            document.getElementById('s-submit-btn').innerHTML = '<i class="bi bi-plus-lg"></i> Add Service';
            document.getElementById('s-cancel-btn').style.display = 'none';
        }

        function removeServiceItem(id) {
            if (confirm('Delete this service?')) {
                DataManager.deleteService(id);
                // Also reset form if we deleted the currently edited item
                if (document.getElementById('s-id').value === id) {
                    resetServiceForm();
                }
                renderServices();
            }
        }

        // --- Blogs ---
        function renderBlogs() {
            const list = document.getElementById('blogs-list');
            list.innerHTML = '';
            DataManager.getBlogs().forEach(b => {
                list.innerHTML += `
                    <div class="admin-item-card">
                        <button class="delete-btn" onclick="removeBlogItem('${b.id}')"><i class="bi bi-trash"></i></button>
                        <button class="edit-btn" onclick='editBlog(${JSON.stringify(b)})'><i class="bi bi-pencil"></i></button>
                        <img src="${b.image}" class="admin-item-img">
                        <div class="admin-item-body">
                            <h4>${b.title}</h4>
                            <p style="color: var(--primary); font-size: 0.8rem;">${b.category} • ${b.date}</p>
                        </div>
                    </div>
                `;
            });
        }

        function handleBlogSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('b-id').value;
            const blog = {
                title: document.getElementById('b-title').value,
                category: document.getElementById('b-cat').value,
                image: document.getElementById('b-img').value,
                snippet: document.getElementById('b-snippet').value
            };

            if (id) {
                // Update
                // Preserve original date unless we want to change it (keeping original date for now)
                const original = DataManager.getBlogs().find(b => b.id === id);
                blog.id = id;
                blog.date = original.date;
                DataManager.updateBlog(blog);
                alert('Blog Updated!');
            } else {
                // Add
                DataManager.addBlog(blog);
                alert('Blog Published!');
            }

            resetBlogForm();
            renderBlogs();
        }

        function editBlog(blog) {
            document.getElementById('b-id').value = blog.id;
            document.getElementById('b-title').value = blog.title;
            document.getElementById('b-cat').value = blog.category;
            document.getElementById('b-img').value = blog.image;
            document.getElementById('b-snippet').value = blog.snippet;

            document.getElementById('b-submit-btn').innerHTML = '<i class="bi bi-check-lg"></i> Update Blog';
            document.getElementById('b-cancel-btn').style.display = 'inline-flex';
            window.scrollTo(0, 0);
        }

        function resetBlogForm() {
            document.getElementById('blog-form').reset();
            document.getElementById('b-id').value = '';
            document.getElementById('b-submit-btn').innerHTML = '<i class="bi bi-pencil-square"></i> Publish Blog';
            document.getElementById('b-cancel-btn').style.display = 'none';
        }

        function removeBlogItem(id) {
            if (confirm('Delete this blog?')) {
                DataManager.deleteBlog(id);
                if (document.getElementById('b-id').value === id) {
                    resetBlogForm();
                }
                renderBlogs();
            }
        }

        // --- Story ---
        async function loadDashboard() {
            // Stats
            const services = DataManager.getServices();
            const visits = DataManager.getVisits();
            const adminData = DataManager.getAdminData(); // Use new getter

            // Safe update of counters
            const sEl = document.getElementById('total-services'); if (sEl) sEl.innerText = services.length;
            const vEl = document.getElementById('total-visits'); if (vEl) vEl.innerText = visits;

            // Profile Data
            const profile = adminData.profile || {};
            if (document.getElementById('admin-name')) document.getElementById('admin-name').innerText = profile.name || 'Admin';
            if (document.getElementById('admin-role')) document.getElementById('admin-role').innerText = profile.role || 'Admin';
            if (document.getElementById('admin-email')) document.getElementById('admin-email').innerText = profile.email || 'admin@kwikklin.com';
            if (document.getElementById('admin-phone')) document.getElementById('admin-phone').innerText = profile.phone || '9696856069';

            // Login Logs
            const logs = adminData.loginLog || {};
            if (document.getElementById('last-login')) document.getElementById('last-login').innerText = logs.lastLogin || 'Never';
            if (document.getElementById('failed-attempts')) document.getElementById('failed-attempts').innerText = logs.failedAttempts || 0;
            if (document.getElementById('login-device')) document.getElementById('login-device').innerText = logs.device || '-';

            // Settings Toggles
            const settings = adminData.settings || {};
            if (document.getElementById('toggle-maintenance')) document.getElementById('toggle-maintenance').checked = settings.maintenanceMode;
            if (document.getElementById('toggle-orders')) document.getElementById('toggle-orders').checked = settings.allowOrders;
            if (document.getElementById('toggle-blogs')) document.getElementById('toggle-blogs').checked = settings.allowBlogs;
        }

        function loadStory() {
            const s = DataManager.getStory();
            document.getElementById('st-title').value = s.title;
            document.getElementById('st-subtitle').value = s.subtitle;
            document.getElementById('st-img').value = s.image;
            document.getElementById('st-content').value = s.content;
            document.getElementById('st-vision').value = s.vision;
        }

        function updateStory(e) {
            e.preventDefault();
            const s = {
                title: document.getElementById('st-title').value,
                subtitle: document.getElementById('st-subtitle').value,
                image: document.getElementById('st-img').value,
                content: document.getElementById('st-content').value,
                vision: document.getElementById('st-vision').value
            };
            DataManager.updateStory(s);
            alert('Story Updated Successfully!');
        }

    </script>
</body>

</html>
```